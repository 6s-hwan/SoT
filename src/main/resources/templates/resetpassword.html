<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- CSS 파일 경로 (Thymeleaf로 동적 처리 가능) -->
    <link rel="stylesheet" th:href="@{/css/changenewpw.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />
    <link rel="stylesheet" th:href="@{/css/nav.css}" />

    <link
            rel="stylesheet"
            type="text/css"
            href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet" />

    <title>SoT - 비밀번호 변경</title>
</head>
<body>
<!-- 내비게이션바 -->
<nav class="navbar">
    <div class="nav_logo">
        <div id="nav_left">
            <!-- 로고 -->
            <div id="nav_logo1">
                <a href="./home">
                    <img th:src="@{/images/MainLogo.png}" alt="로고" width="200px" height="46px" />
                </a>
            </div>
            <!-- 메뉴바 -->
            <div class="nav_menu">
                <ul class="navigation">
                    <li><a href="/home" class="bh">홈</a></li>
                    <li><a href="./local" class="c">지역</a></li>
                    <li><a href="./popular" class="d">인기 작가</a></li>
                </ul>
            </div>
            <!-- 검색바 -->
            <form action="/search" method="get" id="search">
                <input type="text" name="query" class="search" />
                <button type="submit" id="searchBtn" style="background: none; border: none;">
                    <img th:src="@{/images/search.png}" alt="돋보기" id="searchIcon" width="30px" height="30px" />
                </button>
            </form>
        </div>
        <div id="nav_right">
            <input type="button" class="followingbtn" style="display: none" onclick="location.href='follows'" />
            <input type="button" class="imagebtn" style="display: none" onclick="location.href='bookmark'" />
            <input type="button" id="uploadbtn" style="display: none" />

            <input type="checkbox" id="join" style="display: none" />
            <label for="join" id="loginLabel" onclick="toggleDropdown()">로그인</label>
            <!-- 드롭다운 메뉴 -->
            <div id="dropdownMenu" class="dropdown-content" style="display: none">
                <button onclick="location.href='/my-page'">마이페이지</button>
                <button onclick="document.getElementById('bg_gray11').style.display='block';">비밀번호 변경</button>
                <form action="/logout" method="post">
                    <button type="submit">로그아웃</button>
                </form>
            </div>
        </div>
    </div>
</nav>

<!-- 비밀번호 변경 섹션 -->
<div id="changenewpwLink">
    <div id="changenewpwLink1">
        <div id="changenewpwLinkTitle">
            <p id="changenewpwLinktitle1">비밀번호 변경</p>
        </div>

        <!-- 비밀번호 변경 폼 시작 -->
        <form id="resetPasswordForm">
            <input type="hidden" id="token" name="token" th:value="${token}">

            <div id="newpwpart1">
                <div id="newpwparttext1">
                    <p id="currentpwparttext11">새 비밀번호</p>
                    <div id="check_pw11">
                        <span id="text2411">특수문자 포함</span>
                        <div id="imageContainer111" style="display: none">
                            <img id="check_img111" th:src="@{/images/check.png}" alt="check" width="8px" height="5px" />
                        </div>
                        <div id="middle311"></div>
                        <span id="text2511">8자 이상</span>
                        <div id="imageContainer211" style="display: none">
                            <img id="check_img211" th:src="@{/images/check.png}" alt="check" width="8px" height="5px" />
                        </div>
                    </div>
                </div>
                <input type="password" id="newPassword" oninput="checkInputs1p1()" required />
            </div>

            <div id="recheckpwpart1">
                <div id="recheckpwparttext1">
                    <p id="recheckpwparttext11">새 비밀번호 확인</p>
                    <p id="recheckpwparttext21" style="color: red"></p>
                </div>
                <input type="password" id="confirmPassword" oninput="checkPasswordsMatchp1()" required />
            </div>

            <button type="button" id="changenewpwbtn" onclick="resetPassword()">확인</button>
        </form>
        <!-- 비밀번호 변경 폼 끝 -->
    </div>
</div>

<!-- 푸터 -->
<div id="Footer">
    <button class="footer_1" onclick="showPopupf('bg_gray33')">개인정보처리방침</button>
    <button class="footer_2" onclick="showPopupf('bg_gray44')">이용약관</button>
    <p class="email">Contact. Story.of.Travel.official@gmail.com</p>
    <p class="SoT_2024">© 2024 SoT. All rights reserved.</p>
</div>

<!-- JavaScript 부분 -->
<script>
    function resetPassword() {
        const token = document.querySelector('#token').value;
        const newPassword = document.querySelector('#newPassword').value;
        const confirmPassword = document.querySelector('#confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert("비밀번호가 일치하지 않습니다.");
            return;
        }

        fetch('/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: token,
                newPassword: newPassword
            })
        })
            .then(response => {
                if (response.ok) {
                    return response.text();
                } else {
                    throw new Error("비밀번호 변경 실패");
                }
            })
            .then(data => {
                alert("비밀번호가 성공적으로 변경되었습니다.");
                window.location.href = '/home'; // /home 경로로 리디렉션
            })
            .catch(error => {
                alert("비밀번호 변경 중 오류가 발생했습니다.");
            });
    }

</script>

<script th:src="@{/js/Home.js}"></script>
</body>
</html>